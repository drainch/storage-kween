#!/usr/bin/env python3

from dearpygui.dearpygui import *
import os
import subprocess
import time

REQUIRED_COMMANDS = ["du", "find", "fdupes", "paccache", "pacman", "lsblk", "free", "uname"]

def check_dependencies():
    missing = []
    for cmd in REQUIRED_COMMANDS:
        if subprocess.call(f"command -v {cmd}", shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL) != 0:
            missing.append(cmd)
    if missing:
        print("Missing system tools:", ", ".join(missing))
        print("\nInstall them using your package manager:")
        print("sudo pacman -S " + " ".join(missing))
        exit(1)

def run_command_safe(command):
    try:
        output = subprocess.check_output(command, shell=True, stderr=subprocess.STDOUT, text=True)
        return output.strip()
    except subprocess.CalledProcessError as e:
        return f"âš ï¸ Error: {e.output.strip()}"

check_dependencies()

create_context()
set_global_font_scale(1.25)
set_theme("Gold")
create_viewport(title="Storage Queen ğŸ‘‘", width=900, height=600)
setup_dearpygui()

results_cache = ""

def update_panel(label, content):
    delete_item("main_panel", children_only=True)
    add_text(label, parent="main_panel")
    add_separator(parent="main_panel")
    add_text(content, parent="main_panel", wrap=800)

def run_analyzer(sender, app_data, user_data):
    update_panel("ğŸ“Š Disk Analyzer", "Scanning disk usage...")
    output = run_command_safe("du -h --max-depth=1 ~ | sort -hr | head -n 15")
    update_panel("ğŸ“Š Disk Analyzer", output)

def clean_junk(sender, app_data, user_data):
    update_panel("ğŸ§¹ Junk Cleaner", "Cleaning pacman cache and logs...")
    output = run_command_safe("paccache -r")
    output2 = run_command_safe("sudo rm -rf /var/log/*.log")
    update_panel("ğŸ§¹ Junk Cleaner", f"{output}\n{output2}\nDone cleaning. Your majesty's filesystem is fresh.")

def find_large_files(sender, app_data, user_data):
    update_panel("ğŸ” Large Files", "Locating large files (this may take a moment)...")
    output = run_command_safe("find ~ -type f -exec du -h {} + | sort -hr | head -n 15")
    update_panel("ğŸ” Large Files", output)

def find_duplicates(sender, app_data, user_data):
    update_panel("ğŸ§‚ Duplicates", "Scanning Downloads folder for duplicates...")
    output = run_command_safe("fdupes -r ~/Downloads | head -n 40")
    if not output:
        output = "No duplicates found in ~/Downloads."
    update_panel("ğŸ§‚ Duplicates", output)

def safe_delete_mode(sender, app_data, user_data):
    update_panel("ğŸ’£ Safe Delete", "Coming soon: queued deletions and mercy prompts!")

with window(label="Storage Queen ğŸ‘‘", width=900, height=600):
    with group(horizontal=True):
        with child_window(width=180, border=True):
            add_button(label="ğŸ“Š Analyze", callback=run_analyzer)
            add_button(label="ğŸ§¹ Clean Junk", callback=clean_junk)
            add_button(label="ğŸ” Large Files", callback=find_large_files)
            add_button(label="ğŸ§‚ Duplicates", callback=find_duplicates)
            add_button(label="ğŸ’£ Safe Delete", callback=safe_delete_mode)
        with child_window(tag="main_panel", width=700, height=550, border=True):
            add_text("ğŸ‘‘ Welcome to Storage Queen\nClick a button to begin.", wrap=700)
    add_text("Built for the Arch community, with love.", bullet=True)

try:
    show_viewport()
    start_dearpygui()
except KeyboardInterrupt:
    print("ğŸ‘‘ Storage Queen was dismissed by the court.")
finally:
    destroy_context()
